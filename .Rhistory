boxplot(indicator_data$hh_size_mae)
boxplot(indicator_data$hh_size_mae, outline=F)
boxplot(proportion_of_working_members)
# Transformation ----------------------------------------------------------
ihs <- function(x) {
y <- log(x + sqrt(x^2 + 1))
return(y)
}
ihs
working_age_members <- c("males11to24",
"females11to24",
"males25to50",
"females25to50",
"malesover50",
"femalesover50"
)
working_age_members
working_age_members <- c("males11to24",
"females11to24",
"males25to50",
"females25to50",
"malesover50",
"femalesover50"
)
all_dat_temp <- readr::read_csv("~/CGIAR/Hammond, Jim (ILRI) - RHoMIS Global Database Jan 2023/RHoMIS_Data_Processing/merged/processed_data/processed_data.csv")
all_dat_temp <- readr::read_csv("~/CGIAR/Hammond, Jim (ILRI) - RHoMIS Global Database Jan 2023/RHoMIS_Data_Processing/merged/manually_merged/processed_data/processed_data.csv")
table(is.na(all_dat_temp$hh_pop_rep_num_1))
table(is.na(all_dat_temp$person_age_1)
table(is.na(all_dat_temp$person_age_1))
indicator_data$livestock_breeds_1
livestock_column_loop_number <- rhomis::find_number_of_loops(indicator_data,name_column = "livestock_breeds")
livestock_column_loop_number
livestock_column_loop_number <- rhomis::find_number_of_loops(indicator_data,name_column = "livestock_breeds")
loop_columns <- paste0("livestock_breeds_",c(1:livestock_column_loop_number))
loop_columns
find_loop_number_and_extract_values(indicator_data, "livestock_breeds")
breeds_data <- indicator_data[loop_columns]
breeds_data
grepl("improved",breeds_data)
lapply(breeds_data, function(x) {
grepl("improved",x)
}
) %>% bind_cols()
breeds_data
lapply(breeds_data, function(x) {
grepl("local",x)
}
) %>% bind_cols()
grepl("improved",x)
lapply(breeds_data, function(x) {
grepl("improved",x)
}
) %>% bind_cols()
lapply(breeds_data, function(x) {
grepl("improved",x) |   grepl("exotic",x)
}
) %>% bind_cols()
lapply(breeds_data, function(x) {
as.numeric(grepl("improved",x) |   grepl("exotic",x))
}
) %>%
bind_cols() %>%
rowSums(., na.rm=T)
improved_breeds <- lapply(breeds_data, function(x) {
as.numeric(grepl("improved",x) |   grepl("exotic",x))
}
) %>%
bind_cols() %>%
rowSums(., na.rm=T)
table(improved_breeds)
subset_columns <- c("total_income_lcu_per_year","value_farm_products_consumed_lcu_per_hh_per_year")
na.rows <- rowSums(is.na(indicator_data[subset_columns]))==length(subset_columns)
indicator_data$tva_per_hh_per_year <- rowSums(indicator_data[subset_columns], na.rm=T)
indicator_data$tva_per_hh_per_year[na.rows] <- NA
# Tva per mae per day in PPP
subset_columns <- c("tva_per_hh_per_year","hh_size_mae","currency_conversion_lcu_to_ppp")
na.rows <- rowSums(is.na(indicator_data[subset_columns]))==length(subset_columns)
indicator_data$tva_per_mae_per_day_ppp <- indicator_data$tva_per_hh_per_year/indicator_data$hh_size_mae/365/indicator_data$currency_conversion_lcu_to_ppp
indicator_data$tva_per_mae_per_day_ppp[na.rows] <- NA
per_proj_conv_prop_tibble <- make_per_project_conversion_tibble(indicator_data$id_rhomis_dataset,proportion_conversions)
off_farm_prop <- switch_units(data_to_convert = indicator_data$offfarm_income_proportion,unit_tibble = per_proj_conv_prop_tibble,id_vector = indicator_data$id_rhomis_dataset)
off_farm_prop[indicator_data$offfarm_incomes_any=="n"] <- 0
indicator_data$off_farm_any <- as.numeric(off_farm_prop>0)
# Market orientation
subset_columns <- c("value_farm_products_sold_per_hh_per_year","tva_per_hh_per_year")
indicator_data$market_orientation <- indicator_data[["value_farm_products_sold_per_hh_per_year"]]/indicator_data[["tva_per_hh_per_year"]]
indicator_data[["value_farm_products_sold_per_hh_per_year"]]
subset_columns <- c("crop_income_lcu_per_year","livestock_income_lcu_per_year")
na.rows <- rowSums(is.na(indicator_data[subset_columns]))==length(subset_columns)
indicator_data$value_farm_products_sold_per_hh_per_year <- rowSums(indicator_data[subset_columns], na.rm=T)
indicator_data$value_farm_products_sold_per_hh_per_year[na.rows] <- NA
# Market orientation
subset_columns <- c("value_farm_products_sold_per_hh_per_year","tva_per_hh_per_year")
indicator_data$market_orientation <- indicator_data[["value_farm_products_sold_per_hh_per_year"]]/indicator_data[["tva_per_hh_per_year"]]
hist(indicator_data$market_orientation)
table(indicator_data$market_orientation >0.2)
table(indicator_data$market_orientation >0.5)
table(indicator_data$market_orientation >0.25)
table(indicator_data$market_orientation >0.3)
table(indicator_data$market_orientation >0.25)
library(projpred)
library(brms)
library(ggplot2)
loadRData <- function(fileName){
#loads an RData file, and returns it
load(fileName)
get(ls()[ls() != "fileName"])
}
cvvs <- loadRData("outputs/31_05_2023/outputs/overall_models/variable_addition/proj_pred/hdds/weak_prior_fixed/projpred_cv_varsel_model_9.rda")
ref_model <- loadRData("outputs/31_05_2023/outputs/overall_models/variable_addition/hdds/weak_prior_fixed.rda")
cvvs <- loadRData("outputs/31_05_2023/outputs/overall_models/variable_addition/proj_pred/tva/")
cvvs <- loadRData("outputs/31_05_2023/outputs/overall_models/variable_addition/proj_pred/tva/weak_prior_fixed/projpred_cv_varsel_model_1.rda")
ref_model <- loadRData("outputs/31_05_2023/outputs/overall_models/variable_addition/hdds/weak_prior_fixed.rda")
smmry <- summary(cvvs, stats = "mlpd", type = c("mean", "lower", "upper"),
deltas = TRUE)
print(smmry, digits = 1)
# Plotting predictor rank -------------------------------------------------
predictor_plot <- plot(cvvs,deltas = TRUE)
predictor_plot
predictor_plot <- plot(model)#,ranking_abbreviate = T)
# Plotting predictor rank -------------------------------------------------
predictor_plot <- plot(cvvs,deltas = TRUE) +theme(axis.text.x = element_text(angle=90))
predictor_plot
rk <- ranking(cvvs)
rk[["fulldata"]]
pr_rk <- cv_proportions(rk)
plot(pr_rk)
plot(cv_proportions(rk, cumulate = TRUE))
?plot
predictor_plot <- plot(cvvs)#,ranking_abbreviate = T)
predictor_plot
# Plotting predictor rank -------------------------------------------------
predictor_plot <- plot(cvvs,deltas = TRUE,text_angle=90)
predictor_plot
# Plotting predictor rank -------------------------------------------------
predictor_plot <- plot(cvvs,stats="mlpd",deltas = TRUE,text_angle=90)
predictor_plot
cvvs$solution_terms
cvvs$nobs_train
cvvs$solution_terms_cv
cvvs$y_wobs_test
plot.vsel
?get_nfeat_baseline
cvvs$summaries
names(cvvs)
names(cvvs$summaries)
names(cvvs$sub)
dim(cvvs$sub)
cvvs$sub
dim(cvvs$summaries$sub)
cvvs$summaries$sub
length(cvvs$summaries$sub)
cvvs$clust_used_eval
cvvs$solution_terms_cv
projpred::solution_terms(cvvs)
projpred::break_up_matrix_term(cvvs)
.tabulate_stats(cvvs)
projpred::.tabulate_stats(cvvs)
projpred::get_stat(cvvs)
projpred::get_stat(cvvs)
projpred::plot.vsel
summary(get_stat)
summary(cvvs)
summary(cvvs) %>% as_data_frame()
summary(cvvs) %>% as.data.frame()
summary(cvvs) %>% as_tibble()
summary(cvvs)
print(summary(cvvs))
summary(cvvs) %>% unclass()
summary(cvvs) %>% unclass() %>% select("selection")
summary(cvvs) %>% unclass() %>% filter("selection")
unclass(summary(cvvs))[["selection"]]
selection_summary <- unclass(summary(cvvs))[["selection"]]
selection_summary <- unclass(summary(cvvs))[["selection"]]
selection_summary$solution_terms <- gsub("(1 | iso_country_code) + (1 | iso_country_code:village)","location_grouping",selection_summary$solution_terms)
selection_summary
selection_summary <- selection_summary[complete.cases(selection_summary),]
ggplot(selection_summary)+
geom_point(y=elpd.kfold, solution_terms,)
ggplot(selection_summary)+
geom_point(y=elpd.kfold, x=size)
ggplot(selection_summary)+
geom_point(aes(y=elpd.kfold, x=size))
ggplot(selection_summary)+
geom_point(aes(y=elpd.kfold, x=size))+
hline(yintercept=0)
?hline
ggplot(selection_summary)+
geom_point(aes(y=elpd.kfold, x=size))+
geom_hline(yintercept=0)
selection_summary <- unclass(summary(cvvs))[["selection"]]
selection_summary$solution_terms <- gsub("(1 | iso_country_code) + (1 | iso_country_code:village)","location_grouping",selection_summary$solution_terms)
ggplot(selection_summary)+
geom_point(aes(y=elpd.kfold, x=size))+
geom_hline(yintercept=0)
cvvs <- loadRData("outputs/31_05_2023/outputs/overall_models/variable_addition/proj_pred/hdds/weak_prior_fixed/projpred_cv_varsel_model_8.rda")
# pr_rk <- cv_proportions(rk)
# plot(pr_rk)
rk <- ranking(cvvs)
plot(cv_proportions(rk, cumulate = TRUE))
size_decided <- 12
predictors_final <- head(rk[["fulldata"]], size_decided)
# pr_rk <- cv_proportions(rk)
# plot(pr_rk)
rk <- ranking(cvvs)
plot(cv_proportions(rk, cumulate = TRUE))
ggplot(selection_summary)+
geom_point(aes(y=elpd.kfold, x=size))+
geom_hline(yintercept=0)
?cv_varsel
table(indicator_data$market_orientation > 0.25)
source("~/research/phd/chapter-6-analysis/src/02-data-exploration/04-aggregating-categories.R")
scp -r ./data/02-prepared-data  lg14410@bc4login.acrc.bris.ac.uk:/user/work/lg14410/chapter-6/data/
models <-  list(
# -------------------------------------------------------------------------
# -------------------------------------------------------------------------
# TVA --------------------------------------------------------
# -------------------------------------------------------------------------
# -------------------------------------------------------------------------
# -------------------------------------------------------------------------
# -------------------------------------------------------------------------
# Weak Prior Model --------------------------------------------------------
# -------------------------------------------------------------------------
# -------------------------------------------------------------------------
list(
tag="weak_fixed_only",
data=indicator_data,
formula=bf(log_tva ~ 1 +
#Household Level
# Demographics
log_hh_size +
education_cleaned +
#Assets
log_livestock_tlu +
log_land_cultivated +
# Practices
off_farm_any+
till_not_by_hand+
external_labour+
pesticide+
debts_have+
aidreceived+
livestock_inputs_any+
land_irrigated_any+
#------------------
# Village Level
norm_growing_period +
log_min_travel_time +
log_pop_dens +
#------------------
#County Level
norm_gdl_country_shdi),
prior="weak"),
list(
tag="weak_prior_fixed",
data=indicator_data,
formula=bf(log_tva ~ 1 +
#------------------
#Household Level
# Demographics
log_hh_size +
education_cleaned +
#Assets
log_livestock_tlu +
log_land_cultivated +
# Practices
off_farm_any+
till_not_by_hand+
external_labour+
pesticide+
debts_have+
aidreceived+
livestock_inputs_any+
land_irrigated_any+
#------------------
# Village Level
norm_growing_period +
log_min_travel_time +
log_pop_dens +
#------------------
#County Level
norm_gdl_country_shdi+
# Levels
(1 | iso_country_code) +
(1 | iso_country_code:village)),
prior="weak"
),
list(
tag="weak_prior_mixed_country",
data=indicator_data,
formula=bf(log_tva ~ 1 +
#Household Level
# Demographics
log_hh_size +
education_cleaned +
#Assets
log_livestock_tlu +
log_land_cultivated +
# Practices
off_farm_any+
till_not_by_hand+
external_labour+
pesticide+
debts_have+
aidreceived+
livestock_inputs_any+
land_irrigated_any+
#------------------
# Village Level
norm_growing_period +
log_min_travel_time +
log_pop_dens +
#------------------
#County Level
norm_gdl_country_shdi+
# Levels
(1 +
log_land_cultivated +
log_livestock_tlu +
off_farm_any | iso_country_code) +
(1 | iso_country_code:village)),
prior="weak"),
# -------------------------------------------------------------------------
# -------------------------------------------------------------------------
# HDDS --------------------------------------------------------
# -------------------------------------------------------------------------
# -------------------------------------------------------------------------
# -------------------------------------------------------------------------
# -------------------------------------------------------------------------
# Weak Prior Model --------------------------------------------------------
# -------------------------------------------------------------------------
# -------------------------------------------------------------------------
list(
tag="weak_fixed_only",
data=indicator_data,
formula=bf(norm_hdds_lean_season ~ 1 +
#Household Level
# Demographics
log_hh_size +
education_cleaned +
#Assets
log_livestock_tlu +
log_land_cultivated +
# Practices
off_farm_any+
till_not_by_hand+
external_labour+
pesticide+
debts_have+
aidreceived+
livestock_inputs_any+
land_irrigated_any+
#------------------
# Village Level
norm_growing_period +
log_min_travel_time +
log_pop_dens +
#------------------
#County Level
norm_gdl_country_shdi),
prior="weak"),
list(
tag="weak_prior_fixed",
data=indicator_data,
formula=bf(norm_hdds_lean_season ~ 1 +
#------------------
#Household Level
# Demographics
log_hh_size +
education_cleaned +
#Assets
log_livestock_tlu +
log_land_cultivated +
# Practices
off_farm_any+
till_not_by_hand+
external_labour+
pesticide+
debts_have+
aidreceived+
livestock_inputs_any+
land_irrigated_any+
#------------------
# Village Level
norm_growing_period +
log_min_travel_time +
log_pop_dens +
#------------------
#County Level
norm_gdl_country_shdi+
# Levels
(1 | iso_country_code) +
(1 | iso_country_code:village)),
prior="weak"
),
list(
tag="weak_prior_mixed_country",
data=indicator_data,
formula=bf(norm_hdds_lean_season ~ 1 +
#Household Level
# Demographics
log_hh_size +
education_cleaned +
#Assets
log_livestock_tlu +
log_land_cultivated +
# Practices
off_farm_any+
till_not_by_hand+
external_labour+
pesticide+
debts_have+
aidreceived+
livestock_inputs_any+
land_irrigated_any+
log_pop_dens +
#------------------
# Village Level
norm_growing_period +
log_min_travel_time +
log_pop_dens +
#------------------
#County Level
norm_gdl_country_shdi+
# Levels
(1 +
log_land_cultivated +
log_livestock_tlu +
off_farm_any | iso_country_code) +
(1 | iso_country_code:village)),
prior="weak")
)
models
# Market Orientation (Logit)
modelling_data_set$logit_market_orientation <- logit(modelling_data_set$market_orientation)
modelling_data_set$logit_market_orientation <- normalisation(modelling_data_set$logit_market_orientation)
modelling_data_set$market_orientation
source("~/research/phd/chapter-6-analysis/src/02-data-exploration/04-aggregating-categories.R")
auxilliary_variables <- c(
"log_hh_size",
'education_cleaned',
#Assets
'log_livestock_tlu',
'log_land_cultivated',
"logit_market_orientation",
# Practices
'off_farm_any',
'till_not_by_hand',
'external_labour',
'pesticide',
'debts_have',
'aidreceived',
'livestock_inputs_any',
'land_irrigated_any',
#------------------
# Village Level
'norm_growing_period',
'log_min_travel_time',
'log_pop_dens',
#------------------
#County Level
'norm_gdl_country_shdi'
)
auxilliary_variables
length(auxilliary_variables)
# Adapted from Frank Weber's Solution
# https://github.com/stan-dev/projpred/issues/346
get_search_terms <- function(fixed_terms, other_predictors, max_terms) {
if (max_terms > length(other_predictors)){
stop("Cannot have max terms more than predictors")
}
search_terms <- unlist(lapply(1:max_terms, function(m_predictors) {
lapply(combn(other_predictors, m = m_predictors, simplify = FALSE),
function(idxs_predictors) {
paste0(idxs_predictors, collapse = " + ")
})
}))
search_terms <- c(fixed_terms, paste(fixed_terms, "+", search_terms))
return(search_terms)
}
auxilliary_variables <- c(
"log_hh_size",
'education_cleaned',
#Assets
'log_livestock_tlu',
'log_land_cultivated',
"logit_market_orientation",
# Practices
'off_farm_any',
'till_not_by_hand',
'external_labour',
'pesticide',
'debts_have',
'aidreceived',
'livestock_inputs_any',
'land_irrigated_any',
#------------------
# Village Level
'norm_growing_period',
'log_min_travel_time',
'log_pop_dens',
#------------------
#County Level
'norm_gdl_country_shdi'
)
group_effects <-"(1 | iso_country_code) + (1 | iso_country_code:village)"
# Basing this off of discussion on stan forum:
# https://discourse.mc-stan.org/t/projpred-fixing-group-effects-in-search-terms-and-tips-for-speed/31678/4
search_terms <- get_search_terms(group_effects,auxilliary_variables, max_terms=length(auxilliary_variables))
search_terms
library(readr)
length(auxilliary_variables)
